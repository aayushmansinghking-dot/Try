<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP RESIDENCY | Royal Estate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Lato:wght@300;400;700&family=Pinyon+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- THEME --- */
        :root {
            --gold: #C5A059;
            --gold-light: #E6C888;
            --gold-dark: #806020;
            --black-deep: #020202;
            --panel: rgba(10, 12, 10, 0.96);
            --border: 1px solid rgba(197, 160, 89, 0.3);
            --text: #F0F0F0;
            --emerald: #104030;
            --ruby: #501010;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: var(--black-deep); color: var(--text); 
            font-family: 'Lato', sans-serif; overflow-x: hidden; padding-bottom: 70px; 
        }

        /* --- BACKGROUND --- */
        .bg-imperial {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: 
                radial-gradient(circle at 50% 0%, #151515, transparent 80%),
                linear-gradient(0deg, #000 0%, #080808 100%);
        }

        /* --- ENTRY SCREEN (TRIGGER) --- */
        #entry-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 30000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease;
        }
        
        .entry-logo {
            font-family: 'Cinzel'; font-size: 4rem; color: var(--gold);
            text-shadow: 0 0 30px var(--gold-dark); margin-bottom: 50px;
            animation: pulse 3s infinite;
        }

        /* --- VIDEO LAYER --- */
        #video-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000; display: none; /* Hidden until clicked */
        }
        #intro-video { width: 100%; height: 100%; object-fit: cover; }
        
        #skip-btn {
            position: absolute; bottom: 30px; right: 30px;
            background: rgba(0,0,0,0.6); border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 20px; font-family: 'Cinzel'; cursor: pointer;
            z-index: 20001; opacity: 0.7; transition: 0.3s;
        }
        #skip-btn:hover { opacity: 1; background: #000; }

        /* --- MAIN APP LAYOUT --- */
        .screen { 
            display: none; max-width: 900px; margin: 0 auto; padding: 60px 20px; 
            animation: fadeIn 1s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 50% { opacity: 0.7; transform: scale(0.98); } }

        .card {
            background: var(--panel); border: var(--border); padding: 50px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.9); position: relative;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }

        /* --- TYPOGRAPHY --- */
        h1, h2 { font-family: 'Cinzel', serif; text-align: center; color: var(--gold); text-transform: uppercase; }
        h1 { font-size: 3.5rem; margin-bottom: 5px; }
        h2 { font-size: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 40px; letter-spacing: 4px; }
        h3 { color: var(--gold-light); font-size: 0.9rem; text-transform: uppercase; margin-top: 40px; border-left: 3px solid var(--gold); padding-left: 15px; letter-spacing: 2px; }

        /* --- FORMS --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media(max-width: 650px) { .grid { grid-template-columns: 1fr; } }

        label { display: block; color: #888; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 2px; }
        
        input, select {
            width: 100%; padding: 15px; background: rgba(255,255,255,0.03);
            border: 1px solid #333; color: white; border-radius: 0;
            font-family: 'Lato', sans-serif; font-size: 1.1rem; transition: 0.4s;
        }
        input:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(197, 160, 89, 0.1); }
        .input-err { border-color: var(--ruby); animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 20px; margin-top: 40px;
            background: transparent; border: 1px solid var(--gold);
            color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.9rem;
            cursor: pointer; transition: 0.5s; letter-spacing: 3px; text-transform: uppercase;
        }
        .btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 30px rgba(197, 160, 89, 0.4); }
        
        .btn-filled { background: var(--gold); color: #000; font-weight: bold; }
        .btn-filled:hover { background: #fff; box-shadow: 0 0 40px rgba(255,255,255,0.3); }

        .btn-start {
            padding: 20px 60px; font-size: 1.2rem; background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: #000; border: none; cursor: pointer; font-family: 'Cinzel'; letter-spacing: 4px;
            transition: 0.5s;
        }
        .btn-start:hover { transform: scale(1.05); box-shadow: 0 0 50px var(--gold); }

        .btn-corner { 
            position: fixed; bottom: 80px; right: 20px; width: auto; padding: 10px 25px; 
            font-size: 0.7rem; opacity: 0.6; background: #000; border: 1px solid #444; 
            color: #888; z-index: 100; font-family: 'Cinzel';
        }

        /* --- TABLES & IMAGES --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { color: var(--gold); padding: 15px; border-bottom: 1px solid var(--gold); text-align: center; font-family: 'Cinzel'; font-size: 0.8rem; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); color: #aaa; }
        
        .img-prev { width: 100%; height: 200px; object-fit: contain; border: 1px solid var(--gold); background: #000; margin-top: 10px; }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 15000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 1px; height: 100px; background: linear-gradient(to bottom, transparent, var(--gold), transparent);
            animation: beam 1.5s infinite;
        }
        @keyframes beam { 0% { opacity:0.3; height:50px; } 50% { opacity:1; height:120px; box-shadow: 0 0 20px var(--gold); } 100% { opacity:0.3; height:50px; } }

        /* --- NOTIFICATIONS --- */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150%);
            background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: black; 
            padding: 15px 40px; border-radius: 2px; font-weight: 800; font-family: 'Cinzel'; 
            z-index: 100000; transition: 0.5s; box-shadow: 0 0 30px rgba(197, 160, 89, 0.4);
            border: 1px solid white; text-align: center; min-width: 300px;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #toast.error { background: linear-gradient(135deg, #800, #f00); color: white; border: none; }

        /* --- SUCCESS CARD --- */
        .invite-card {
            border: 2px solid var(--gold); padding: 60px 40px; text-align: center;
            background: linear-gradient(180deg, rgba(197, 160, 89, 0.08), transparent);
            margin: 30px 0;
        }
        .invite-title { font-family: 'Italianno', cursive; font-size: 4rem; color: var(--gold); margin-bottom: 10px; }
        
        /* --- DYNAMIC & OWNER FIELDS --- */
        .dynamic-box { border: 1px dashed var(--gold); padding: 20px; margin-top: 20px; position: relative; background: rgba(0,0,0,0.3); }
        .demand-input {
            text-align: right; border: 1px solid var(--emerald) !important; padding: 10px !important;
            font-family: 'Cinzel'; color: var(--emerald) !important; font-size: 1.2rem !important;
        }
        .demand-input:disabled { border: none !important; color: #fff !important; }
        
        /* --- FOOTER --- */
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #000;
            border-top: 1px solid var(--gold-dark); padding: 15px; text-align: center;
            font-size: 0.8rem; color: var(--gold); z-index: 9999; letter-spacing: 2px;
            font-family: 'Cinzel'; text-transform: uppercase;
        }

    </style>
</head>
<body>

    <div class="bg-imperial"></div>
    <div id="toast">Message</div>

    <div class="sticky-footer">
        Concierge Services: XXX-XXX-XXXX
    </div>

    <div id="entry-screen">
        <div class="entry-logo">JP RESIDENCY</div>
        <button class="btn-start" onclick="window.startExperience()">ENTER RESIDENCE</button>
    </div>

    <div id="video-layer">
        <video id="intro-video" playsinline>
            <source src="work.mp4" type="video/mp4">
        </video>
        <button id="skip-btn" onclick="window.endIntro()">SKIP INTRO</button>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:30px; color:var(--gold); font-family:'Cinzel'; letter-spacing:4px; font-size:0.8rem;">PROCESSING REQUEST</div>
    </div>

    <div id="pg-home" class="screen">
        <div class="card" style="text-align: center; padding: 120px 40px;">
            <h1 style="font-size:6rem; line-height:1; color:#fff;">JP</h1>
            <div style="width: 2px; height: 60px; background: var(--gold); margin: 20px auto;"></div>
            <p style="letter-spacing: 12px; color: var(--gold); font-family: 'Cinzel'; margin-bottom: 80px;">RESIDENCY</p>
            
            <button class="btn btn-filled" onclick="window.nav('pg-reg')">Guest Registration</button>
            <button class="btn" onclick="window.nav('pg-login')">Resident Portal</button>
        </div>
        <button class="btn-corner" onclick="window.nav('pg-owner')">Owner</button>
    </div>

    <div id="pg-reg" class="screen">
        <div class="card">
            <h2>Guest Application</h2>
            <form id="regForm" onsubmit="return false;">
                
                <h3>Personal Details</h3>
                <div class="grid">
                    <div><label>Full Name</label><input type="text" id="r-name"></div>
                    <div><label>Gender</label><select id="r-gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
                </div>
                <div class="grid">
                    <div><label>Phone Number</label><input type="tel" id="r-phone"></div>
                    <div><label>Email Address</label><input type="email" id="r-email"></div>
                </div>
                <div class="grid">
                    <div><label>Permanent Address</label><input type="text" id="r-addr"></div>
                    <div><label>Office/School Address</label><input type="text" id="r-office"></div>
                </div>

                <h3>Identification</h3>
                <div class="grid">
                    <div><label>ID Type</label><select id="r-idtype"><option>Aadhar Card</option><option>Passport</option><option>Voter ID</option></select></div>
                    <div><label>ID Number</label><input type="text" id="r-idnum"></div>
                </div>

                <h3>Residence Details</h3>
                <div style="margin-bottom:20px;"><label>Purpose of Living</label><input type="text" id="r-purpose"></div>

                <div class="grid">
                    <div><label>Start Date</label><input type="date" id="r-date"></div>
                    <div><label>No. of Guests</label><input type="number" id="r-guests" min="1" oninput="window.generateMembers()"></div>
                </div>

                <div id="dynamic-members"></div>

                <div class="grid" style="margin-top:20px;">
                    <div><label>Rent Per Month (₹)</label><input type="number" id="r-rent"></div>
                    <div><label>Advance Paid (₹)</label><input type="number" id="r-adv"></div>
                </div>
                <div><label>Previous Meter Reading</label><input type="number" id="r-meter"></div>

                <h3>Documents (Max 2MB)</h3>
                <div class="grid">
                    <div><label>Primary Aadhar</label><input type="file" id="f-aadhar" accept="image/*"></div>
                    <div><label>Signature</label><input type="file" id="f-sig" accept="image/*"></div>
                </div>
                <div><label>Meter Photo</label><input type="file" id="f-meter" accept="image/*"></div>

                <div id="dynamic-photos" style="margin-top:20px;"></div>

                <h3>Security</h3>
                <div><label>Create Password</label><input type="password" id="r-pass"></div>

                <div class="grid" style="margin-top:40px;">
                    <button class="btn" style="border:1px solid #444; background:transparent; color:#888;" onclick="window.nav('pg-home')">Back</button>
                    <button class="btn btn-filled" onclick="window.submitReg()">Submit Application</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pg-success" class="screen">
        <div class="card" style="text-align: center; padding: 60px;">
            
            <div class="invite-card">
                <div class="invite-title">Welcome to the Residence</div>
                <h2 id="suc-name" style="border:none; color:white; font-size:1.8rem; letter-spacing:3px; margin: 20px 0;">Mr. Name</h2>
                
                <hr style="border:none; border-top:1px solid var(--gold); width: 50px; margin: 30px auto;">
                
                <p style="color:var(--gold-light); font-size:0.7rem; letter-spacing:4px; text-transform:uppercase;">RESIDENCY ID</p>
                <div id="suc-id" style="font-size:3.5rem; color:var(--gold); font-family:'Cinzel'; margin-bottom:40px;">JP0000</div>
                
                <p style="font-family:'Lato'; font-style:italic; color:#aaa;">You are now a distinguished member of the family.</p>
            </div>
            
            <a href="https://chat.whatsapp.com/EVR6vqGqfvw2yWR7qEo72R?mode=gi_c" target="_blank" class="btn btn-filled" style="display:block; text-decoration:none; margin-bottom:20px;">
                <i class="fas fa-users"></i> Join Residential Group
            </a>
            
            <button class="btn" onclick="window.whatsapp()">WhatsApp Owner</button>
            <button class="btn" style="background:transparent; border:none; color:#666; margin-top:20px;" onclick="window.nav('pg-home')">Return to Main</button>
        </div>
    </div>

    <div id="pg-login" class="screen">
        <div class="card">
            <h2>Resident Login</h2>
            <label>Registration ID</label><input id="l-id" placeholder="JP...">
            <label style="margin-top:20px;">Password</label><input type="password" id="l-pass">
            <button class="btn btn-filled" onclick="window.login()">Enter</button>
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-home')">Back</button>
        </div>
    </div>

    <div id="pg-owner" class="screen">
        <div class="card">
            <h2>Owner Access</h2>
            <label>Security Key</label><input type="password" id="o-pass">
            <button class="btn btn-filled" onclick="window.ownerLogin()">Unlock</button>
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-home')">Back</button>
        </div>
    </div>

    <div id="pg-list" class="screen">
        <div class="card">
            <h2>Directory</h2>
            <div id="list-box" style="max-height:400px; overflow-y:auto; padding:10px;"></div>
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-home')">Logout</button>
        </div>
    </div>

    <div id="pg-dash" class="screen">
        <h2 id="dash-head" style="text-align:center; color:#fff; border:none; letter-spacing:5px;">RESIDENCE</h2>
        
        <div class="card" id="dash-card">
            <div id="owner-tools" style="display:none; text-align:right; margin-bottom:20px;">
                <button class="btn" style="width:auto; padding:10px 20px; font-size:0.7rem; margin:0; background:var(--emerald); border-color:var(--emerald);" onclick="window.saveChanges()">Save</button>
                <button class="btn" style="width:auto; padding:10px 20px; font-size:0.7rem; border-color:#333; color:#666; margin:0; background:transparent;" onclick="window.nav('pg-list')">List</button>
            </div>

            <h3>Profile</h3>
            <div class="grid">
                <div><label>Name</label><input id="d-name" disabled></div>
                <div><label>Reg ID</label><input id="d-id" disabled style="color:var(--gold);"></div>
            </div>
            <div class="grid">
                <div><label>Phone</label><input id="d-phone" disabled></div>
                <div><label>Email</label><input id="d-email" disabled></div>
            </div>
            <div><label>Address</label><input id="d-addr" disabled></div>
            <div><label>Office/School</label><input id="d-office" disabled></div>

            <h3>Identity</h3>
            <div class="grid">
                <div><label>Type</label><input id="d-idtype" disabled></div>
                <div><label>Number</label><input id="d-idnum" disabled></div>
            </div>

            <h3>Details</h3>
            <div class="grid">
                <div><label>Date</label><input id="d-date" disabled></div>
                <div><label>Guests</label><input id="d-guests" disabled></div>
            </div>
            <div><label>Purpose</label><input id="d-purpose" disabled></div>
            <div class="grid">
                <div><label>Rent</label><input id="d-rent" disabled></div>
                <div><label>Advance</label><input id="d-adv" disabled></div>
            </div>
            <div><label>Start Reading</label><input id="d-meter" disabled></div>
            <div><label>Password</label><input id="d-pass" disabled style="color:#aaa;"></div>

            <div id="dash-members"></div>

            <h3>Documents</h3>
            <div class="grid">
                <div><label>Aadhar</label><img id="img-aadhar" class="img-prev"></div>
                <div><label>Signature</label><img id="img-sig" class="img-prev"></div>
            </div>
            <div id="dash-photos" class="grid" style="margin-top:15px;"></div>
        </div>

        <div class="card" style="margin-top:20px;">
            <div class="grid">
                <button class="btn" style="margin:0;" onclick="window.pageRent()">Rent Record</button>
                <button class="btn" style="margin:0;" onclick="window.pageElec()">Electric Bill</button>
            </div>
            <button class="btn btn-filled" onclick="window.pageDemand()">Net Demand</button>
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-home')">Sign Out</button>
        </div>
    </div>

    <div id="pg-sub-rent" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; border:none;">Rent Ledger</h2>
                <button id="save-rent-btn" class="btn" style="width:auto; padding:10px; margin:0; font-size:0.7rem; display:none; background:var(--emerald); border:none;" onclick="window.saveRentTable()">SAVE</button>
            </div>
            <label>Fiscal Year</label><input value="2026" disabled>
            <table id="t-rent">
                <thead><tr><th>Month</th><th>Amt</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-dash')">Back</button>
        </div>
    </div>

    <div id="pg-sub-elec" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; border:none;">Electric</h2>
                <button id="save-elec-btn" class="btn" style="width:auto; padding:10px; margin:0; font-size:0.7rem; display:none; background:var(--emerald); border:none;" onclick="window.saveElecTable()">SAVE</button>
            </div>
            
            <div style="text-align:center; padding:10px; margin-bottom:30px;">
                <label style="color:var(--gold);">Ref: Start Meter</label>
                <img id="img-meter-ref" class="img-prev" style="height:150px; border:none;">
            </div>

            <div id="owner-add-bill" style="display:none; padding-bottom:30px; border-bottom:1px solid #333; margin-bottom:30px;">
                <h3 style="margin-top:0; border:none;">Add New Reading</h3>
                <div class="grid">
                    <input type="number" id="nb-prev" placeholder="Prev Reading">
                    <input type="number" id="nb-curr" placeholder="Curr Reading">
                </div>
                <div class="grid" style="margin-top:15px;">
                    <input type="number" id="nb-rate" placeholder="Rate" value="10">
                    <button class="btn btn-filled" style="margin:0; font-size:0.7rem;" onclick="window.addBill()">Generate Bill</button>
                </div>
            </div>

            <table id="t-elec">
                <thead><tr><th>Use</th><th>Amt</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>

            <h3>Calculator</h3>
            <div class="grid">
                <input type="number" id="c-p" placeholder="Prev">
                <input type="number" id="c-c" placeholder="Curr">
            </div>
            <button class="btn" onclick="window.calc()">Total: <span id="c-res" style="color:var(--text)">0</span></button>
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-dash')">Back</button>
        </div>
    </div>

    <div id="pg-sub-demand" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; border:none;">Net Demand</h2>
                <button id="save-demand-btn" class="btn" style="width:auto; padding:10px; margin:0; font-size:0.7rem; display:none; background:var(--emerald); border:none;" onclick="window.saveDemand()">SAVE</button>
            </div>

            <div style="margin-top:40px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <label style="font-size:0.9rem;">Rent Due</label>
                    <input type="number" id="nd-rent" class="demand-input" value="0" disabled oninput="window.autoSum()">
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <label style="font-size:0.9rem;">Electric Due</label>
                    <input type="number" id="nd-elec" class="demand-input" value="0" disabled oninput="window.autoSum()">
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <label style="font-size:0.9rem;">Other Charges</label>
                    <input type="number" id="nd-other" class="demand-input" value="0" disabled oninput="window.autoSum()">
                </div>
                
                <hr style="border-color:#333; margin:30px 0;">
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="color:var(--gold); font-size:1.2rem;">TOTAL</label>
                    <div id="nd-total" style="color:var(--gold); font-size:2rem; font-family:'Cinzel';">₹ 0</div>
                </div>
            </div>
            
            <button class="btn" style="border-color:#333; color:#666;" onclick="window.nav('pg-dash')">Back</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVaexSETiqwiqy1TAaVUMq5--_JaxwTRQ",
            authDomain: "jp-residency-70cbf.firebaseapp.com",
            databaseURL: "https://jp-residency-70cbf-default-rtdb.firebaseio.com",
            projectId: "jp-residency-70cbf",
            messagingSenderId: "1084521996397",
            appId: "1:1084521996397:web:30076255d3c65944049f64",
            measurementId: "G-8C3YZ8QC1H"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let user = null;
        let isOwner = false;

        // Video Handling
        const video = document.getElementById('intro-video');
        video.onended = () => { window.endIntro(); };
        window.startExperience = () => {
            document.getElementById('entry-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('entry-screen').style.display = 'none';
                document.getElementById('video-layer').style.display = 'block';
                video.play();
            }, 1000);
        };
        window.endIntro = () => {
            document.getElementById('video-layer').style.display = 'none';
            window.nav('pg-home');
        };

        window.nav = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        };

        const toast = (msg, type='normal') => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = type === 'error' ? 'error show' : 'show';
            setTimeout(() => t.className = '', 3000);
        };

        const loader = (show) => {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        };

        const compress = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const max = 600; const scale = max / img.width;
                    canvas.width = max; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
            reader.onerror = reject;
        });

        // --- DYNAMIC FIELDS ---
        window.generateMembers = () => {
            const count = parseInt(document.getElementById('r-guests').value);
            const memDiv = document.getElementById('dynamic-members');
            const photoDiv = document.getElementById('dynamic-photos');
            
            memDiv.innerHTML = '';
            photoDiv.innerHTML = '';

            if (count > 1) {
                for (let i = 2; i <= count; i++) {
                    const box = document.createElement('div');
                    box.className = 'dynamic-box';
                    box.style.cssText = "border:1px dashed #444; padding:15px; margin-top:15px; position:relative;";
                    box.innerHTML = `
                        <div style="position:absolute; top:-10px; left:10px; background:#000; padding:0 5px; font-size:0.7rem; color:var(--gold);">MEMBER ${i}</div>
                        <div class="grid">
                            <input type="text" id="m-name-${i}" placeholder="Name">
                            <input type="tel" id="m-phone-${i}" placeholder="Phone">
                        </div>
                    `;
                    memDiv.appendChild(box);
                }
            }
            
            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.innerHTML = `<label>Photo Member ${i}</label><input type="file" class="dyn-photo" id="p-mem-${i}" accept="image/*">`;
                div.style.marginTop = "10px";
                photoDiv.appendChild(div);
            }
        };

        // --- SUBMIT REGISTRATION ---
        window.submitReg = async () => {
            const ids = ['r-name','r-phone','r-email','r-addr','r-office','r-purpose','r-idnum','r-date','r-guests','r-rent','r-adv','r-meter','r-pass'];
            let valid = true;
            ids.forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('input-err');
                if(!el.value) { el.classList.add('input-err'); valid = false; }
            });

            const f1 = document.getElementById('f-aadhar').files[0];
            const f2 = document.getElementById('f-sig').files[0];
            const f3 = document.getElementById('f-meter').files[0];

            if(!valid) { toast("Fields Missing", "error"); return; }
            if(!f1 || !f2 || !f3) { toast("Photos Missing", "error"); return; }

            loader(true);

            try {
                const i1 = await compress(f1);
                const i2 = await compress(f2);
                const i3 = await compress(f3);

                const guestCount = parseInt(document.getElementById('r-guests').value);
                let extraMembers = [];
                for(let i = 2; i <= guestCount; i++) {
                    extraMembers.push({
                        name: document.getElementById(`m-name-${i}`).value || '-',
                        phone: document.getElementById(`m-phone-${i}`).value || '-'
                    });
                }

                let residentPhotos = [];
                const dynPhotos = document.querySelectorAll('.dyn-photo');
                for(let input of dynPhotos) {
                    if(input.files[0]) {
                        if(input.files[0].size > 2000000) throw new Error("Image too big (Max 2MB)");
                        residentPhotos.push(await compress(input.files[0]));
                    } else {
                        residentPhotos.push("https://via.placeholder.com/150?text=No+Img");
                    }
                }

                const rid = "JP" + Math.floor(1000 + Math.random() * 9000);
                
                const data = {
                    rid,
                    name: document.getElementById('r-name').value,
                    gender: document.getElementById('r-gender').value,
                    phone: document.getElementById('r-phone').value,
                    email: document.getElementById('r-email').value,
                    addr: document.getElementById('r-addr').value,
                    office: document.getElementById('r-office').value,
                    purpose: document.getElementById('r-purpose').value,
                    idtype: document.getElementById('r-idtype').value,
                    idnum: document.getElementById('r-idnum').value,
                    date: document.getElementById('r-date').value,
                    guests: guestCount,
                    rent: document.getElementById('r-rent').value,
                    adv: document.getElementById('r-adv').value,
                    meter: document.getElementById('r-meter').value,
                    pass: document.getElementById('r-pass').value,
                    imgs: { aadhar: i1, sig: i2, meter: i3 },
                    extras: extraMembers,
                    resPhotos: residentPhotos,
                    rentHist: {}, bills: [], 
                    demand: { rent: 0, elec: 0, other: 0 } 
                };

                await set(ref(db, 'users/' + rid), data);
                
                user = data;
                document.getElementById('suc-name').innerText = "Mr. " + data.name;
                document.getElementById('suc-id').innerText = rid;
                loader(false);
                window.nav('pg-success');

            } catch(e) {
                loader(false);
                toast("Error: " + e.message, "error");
            }
        };

        window.whatsapp = () => {
            const url = `https://wa.me/9942823314?text=New Registration: ${user.name} (${user.rid})`;
            window.open(url, '_blank');
        };

        // --- LOGIN & DASHBOARD ---
        window.login = () => {
            const id = document.getElementById('l-id').value.trim();
            const pass = document.getElementById('l-pass').value;

            if(pass === 'AMS') {
                isOwner = true;
                window.fetchUser(id);
                return;
            }

            loader(true);
            get(child(ref(db), `users/${id}`)).then(snap => {
                loader(false);
                if(snap.exists() && snap.val().pass === pass) {
                    isOwner = false;
                    user = snap.val();
                    window.loadDash();
                } else { toast("Invalid Credentials", "error"); }
            }).catch(e => { loader(false); toast("Connection Error", "error"); });
        };

        window.ownerLogin = () => {
            if(document.getElementById('o-pass').value === 'AMS') {
                isOwner = true;
                window.loadList();
            } else { toast("Access Denied", "error"); }
        };

        window.loadList = () => {
            loader(true);
            get(child(ref(db), 'users')).then(snap => {
                const box = document.getElementById('list-box');
                box.innerHTML = '';
                if(snap.exists()) {
                    snap.forEach(c => {
                        const u = c.val();
                        const d = document.createElement('div');
                        d.innerHTML = `<span style="color:var(--gold); font-weight:bold;">${u.rid}</span> - ${u.name}`;
                        d.style.padding = "15px";
                        d.style.borderBottom = "1px solid #333";
                        d.style.cursor = "pointer";
                        d.onclick = () => { user = u; window.loadDash(); };
                        box.appendChild(d);
                    });
                }
                loader(false);
                window.nav('pg-list');
            });
        };

        window.fetchUser = (id) => {
            get(child(ref(db), `users/${id}`)).then(snap => {
                if(snap.exists()) { user = snap.val(); window.loadDash(); }
                else toast("User not found", "error");
            });
        };

        window.loadDash = () => {
            window.nav('pg-dash');
            
            document.getElementById('d-name').value = user.name;
            document.getElementById('d-id').value = user.rid;
            document.getElementById('d-phone').value = user.phone;
            document.getElementById('d-email').value = user.email;
            document.getElementById('d-addr').value = user.addr;
            document.getElementById('d-office').value = user.office || '-';
            document.getElementById('d-purpose').value = user.purpose || '-';
            document.getElementById('d-idtype').value = user.idtype;
            document.getElementById('d-idnum').value = user.idnum;
            document.getElementById('d-date').value = user.date;
            document.getElementById('d-guests').value = user.guests;
            document.getElementById('d-rent').value = user.rent;
            document.getElementById('d-adv').value = user.adv;
            document.getElementById('d-meter').value = user.meter;
            document.getElementById('d-pass').value = user.pass;

            document.getElementById('img-aadhar').src = user.imgs.aadhar;
            document.getElementById('img-sig').src = user.imgs.sig;
            document.getElementById('img-meter-ref').src = user.imgs.meter;

            const memDiv = document.getElementById('dash-members');
            memDiv.innerHTML = '<h3 style="margin-top:0">Residents</h3>';
            if(user.extras && user.extras.length > 0) {
                user.extras.forEach((m, i) => {
                    memDiv.innerHTML += `<div style="border-bottom:1px solid #333; padding:5px; display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span>${m.name}</span><span style="color:#888">${m.phone}</span>
                    </div>`;
                });
            } else { memDiv.innerHTML += '<p style="color:#666">None</p>'; }

            const photoDiv = document.getElementById('dash-photos');
            photoDiv.innerHTML = '';
            if(user.resPhotos) {
                user.resPhotos.forEach((img, i) => {
                    photoDiv.innerHTML += `<div><label>Resident ${i+1}</label><img src="${img}" class="img-prev"></div>`;
                });
            }

            const inputs = document.querySelectorAll('#dash-card input');
            const tools = document.getElementById('owner-tools');
            const title = document.getElementById('dash-head');
            
            document.querySelectorAll('#save-rent-btn, #save-elec-btn, #save-demand-btn').forEach(b => b.style.display = isOwner ? 'block' : 'none');

            if(isOwner) {
                title.innerText = "OWNER MODE";
                title.style.color = "var(--success)";
                tools.style.display = 'block';
                inputs.forEach(i => i.disabled = false);
                document.getElementById('d-id').disabled = true;
            } else {
                title.innerText = "RESIDENCE";
                title.style.color = "#fff";
                tools.style.display = 'none';
                inputs.forEach(i => i.disabled = true);
            }
        };

        window.saveChanges = async () => {
            const p = `users/${user.rid}`;
            const updates = {};
            updates[`${p}/name`] = document.getElementById('d-name').value;
            updates[`${p}/phone`] = document.getElementById('d-phone').value;
            updates[`${p}/rent`] = document.getElementById('d-rent').value;
            updates[`${p}/pass`] = document.getElementById('d-pass').value;
            
            await update(ref(db), updates);
            toast("Saved Successfully");
            user.name = document.getElementById('d-name').value;
            user.rent = document.getElementById('d-rent').value;
            user.pass = document.getElementById('d-pass').value;
        };
        
        window.saveRentTable = async () => { await set(ref(db, `users/${user.rid}/rentHist`), user.rentHist); toast("Rent Saved"); };
        window.saveElecTable = async () => { await set(ref(db, `users/${user.rid}/bills`), user.bills); toast("Electric Saved"); };

        // --- RENT ---
        window.pageRent = () => {
            window.nav('pg-sub-rent');
            const tb = document.querySelector('#t-rent tbody');
            tb.innerHTML = '';
            const m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const h = user.rentHist || {};

            m.forEach((mo, i) => {
                const k = `2026_${i}`;
                const row = h[k] || {status:'Pending'};
                const tr = document.createElement('tr');
                
                let sHtml = "";
                if(isOwner) {
                    sHtml = `<select onchange="window.upRent('${k}',this.value)" style="background:transparent; color:white; border:none; text-align:center;">
                        <option ${row.status==='Pending'?'selected':''}>Pending</option>
                        <option ${row.status==='Paid'?'selected':''}>Paid</option>
                    </select>`;
                } else {
                    const c = row.status === 'Paid' ? 'var(--success)' : 'var(--error)';
                    sHtml = `<span style="color:${c}; font-weight:bold;">${row.status}</span>`;
                }

                tr.innerHTML = `<td>${mo}</td><td>₹${user.rent}</td><td>${sHtml}</td>`;
                tb.appendChild(tr);
            });
        };

        window.upRent = (k, v) => {
            if(!user.rentHist) user.rentHist = {};
            if(!user.rentHist[k]) user.rentHist[k] = {};
            user.rentHist[k].status = v;
        };

        // --- ELECTRIC ---
        window.pageElec = () => {
            window.nav('pg-sub-elec');
            document.getElementById('owner-add-bill').style.display = isOwner ? 'block' : 'none';
            const tb = document.querySelector('#t-elec tbody');
            tb.innerHTML = '';
            
            tb.innerHTML += `<tr><td>-</td><td>${user.meter}</td><td>-</td><td>Start</td><td>-</td></tr>`;

            const bills = user.bills || [];
            bills.forEach((b, i) => {
                let statusHtml = "";
                if(isOwner) {
                    statusHtml = `<select onchange="window.upElec(${i},this.value)" style="background:transparent; color:white; border:none;">
                        <option ${b.status==='Pending'?'selected':''}>Pending</option>
                        <option ${b.status==='Paid'?'selected':''}>Paid</option>
                    </select>`;
                } else {
                    const c = b.status === 'Paid' ? 'var(--success)' : 'var(--error)';
                    statusHtml = `<span style="color:${c}; font-weight:bold;">${b.status}</span>`;
                }
                tb.innerHTML += `<tr><td>${b.curr - b.prev}</td><td>₹${b.amt}</td><td>${statusHtml}</td></tr>`;
            });
        };

        window.addBill = async () => {
            const p = document.getElementById('nb-prev').value;
            const c = document.getElementById('nb-curr').value;
            const r = document.getElementById('nb-rate').value;
            if(!p || !c) return toast("Enter readings", "error");

            const bill = { prev:p, curr:c, amt:(c-p)*r, date: new Date().toLocaleDateString(), status:'Pending' };
            let bills = user.bills || [];
            bills.push(bill);

            await set(ref(db, `users/${user.rid}/bills`), bills);
            user.bills = bills;
            window.pageElec();
        };

        window.upElec = (idx, val) => {
            user.bills[idx].status = val;
        };

        window.calc = () => {
            const p = document.getElementById('c-p').value;
            const c = document.getElementById('c-c').value;
            document.getElementById('c-res').innerText = "₹" + ((c-p)*10);
        };

        // --- NET DEMAND (MANUAL) ---
        window.pageDemand = () => {
            window.nav('pg-sub-demand');
            
            const d = user.demand || { rent:0, elec:0, other:0 };
            document.getElementById('nd-rent').value = d.rent;
            document.getElementById('nd-elec').value = d.elec;
            document.getElementById('nd-other').value = d.other;
            
            window.autoSum();

            const inputs = document.querySelectorAll('.demand-input');
            if(isOwner) {
                inputs.forEach(i => i.disabled = false);
            } else {
                inputs.forEach(i => i.disabled = true);
            }
        };

        window.autoSum = () => {
            const r = Number(document.getElementById('nd-rent').value) || 0;
            const e = Number(document.getElementById('nd-elec').value) || 0;
            const o = Number(document.getElementById('nd-other').value) || 0;
            document.getElementById('nd-total').innerText = "₹ " + (r + e + o);
        };

        window.saveDemand = async () => {
            const data = {
                rent: Number(document.getElementById('nd-rent').value),
                elec: Number(document.getElementById('nd-elec').value),
                other: Number(document.getElementById('nd-other').value)
            };
            
            await set(ref(db, `users/${user.rid}/demand`), data);
            user.demand = data;
            toast("Demand Updated");
        };

    </script>
</body>
</html>
